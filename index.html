<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" type="text/css" href="//cloud.webtype.com/css/944a7551-9b08-4f0a-8767-e0f83db4a16b.css" />
  <link rel="stylesheet" href="http://style.codeforamerica.org/style/css/main.css">
  <link rel="stylesheet" href="http://style.codeforamerica.org/style/css/layout.css" media="all and (min-width: 40em)">
  <link rel="stylesheet" href="css/style.css">
  <title>Code for All</title>

  <script src='//code.jquery.com/jquery-2.1.0.min.js'></script>
  <link href='//api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
  <script src='//api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>

  <script src='//cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js'></script>
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
  <script src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.min.js'></script>
</head>

<body>

  <div class="global-header-compact" role="banner">
    <a href="http://codeforall.org" class="global-header-logo">
      <img src="images/code_for_all_logo.png" />
    </a>
    <p class="global-header-tagline">An international network of <strong>civic innovators</strong>. </p>
  </div>

  <section>
    <div id="map"></div>
  </section>

  <section class="slab-white">
    <div class="layout-breve">
      <table id="cfa-listings">
      <thead>
        <tr>
          <th>Name</th>
          <th>Latest Project</th>
          <th>Latest News</th>
          <th>Upcoming Event</th>
        </tr>
      </thead>
      </table>
    </div>
  </section>

  <section>
    <div class="layout-breve">
      <div class="badge-heading badge-github badge-blue">
        <h2>Code for All Right Now!</h2>
        <p>These are open GitHub Issues labeled with
          <span class="label" style="background-color:#159818;">help wanted</span>
          from across the civic technology movement. Find more using the
          <a href="http://codeforamerica.org/geeks/civicissues">Civic Tech Issue Finder</a>.</p>
        </div>
        <style>
          .label {
            border: 1px solid #000;
            display: inline-block;
            color: #fff;
            text-align: center;
            border-radius: .33em;
            margin: 5px;
            padding: 0 10px;
            font-family: Interstate, 'Gotham A', 'Gotham B', 'Open Sans Regular', Verdana, Helvetica, Arial;
          }
        </style>
        <iframe id="widget" src="http://codeforamerica.org/geeks/civicissues/widget?org_type=Code+for+All&labels=help wanted&number=3" width="100%" height="320px" frameBorder="0" onLoad="resize();"> </iframe>
      </div>
    </section>

  </body>

  <script>

$(document).ready(function() {

  $.getJSON("http://codeforamerica.org/api/organizations.geojson", function (response){

    var orgs = response;
    var cfallOrgs = [];
    orgs.features.forEach(function(org) {
      if (org.properties.type.indexOf("Code for All") != -1){
        org.properties['marker-symbol'] = 'rocket';
        org.properties['title'] = "<a href="+org.properties.website+">"+org.properties.name + "</a>";
        cfallOrgs.push(org);
      }
    });

    showMap(cfallOrgs);
  });

  function showMap(cfallOrgs){
    // codeforamerica.j113mi4d - code for all
    // codeforamerica.map-hhckoiuj - brigade
    var map = L.mapbox.map('map', 'codeforamerica.map-hhckoiuj',
    {
      scrollWheelZoom:false
    });
    var latlon = [27, 0], zoom = 2;
    map.setView(latlon, zoom);

    // Add the cfall orgs to the map
    var featureLayer = L.mapbox.featureLayer(cfallOrgs).addTo(map);

    featureLayer.on('mouseover', function(e) {
      e.layer.openPopup();
    });

  };

  $('#cfa-listings').dataTable({
    "ajax": function (data, callback, settings) {
      settings.sAjaxDataProp = "objects"
      $.getJSON('http://codeforamerica.org/api/organizations?type=Code+for+All', function(response) {
        callback(response);
      });
    },
    "processing": true,
    "serverSide": false,
    "paging": false,
    "columns": [
      { "data": "name", "render": function (data, type, full, meta) {return data} },
      {
        "width": "20%",
        "data": "current_projects.0.name",
        "defaultContent": "...",
        "render": function (data, type, full, meta) {
          if (full.current_projects.length) {
            return '<a href="'+full.current_projects[0].code_url+'">'+data+'</a><br /><small>'+full.current_projects[0].description+'</small>'
          }
        }
      },
      {
        "data": "current_stories.0.title",
        "defaultContent": "...",
        "render": function (data, type, full, meta) {
          if (full.current_stories.length) {
            return '<a href="'+full.current_stories[0].link+'">'+data+'</a>'
          }
        }
      },
      {
        "data": "current_events.0.name",
        "defaultContent": "...",
        "render": function (data, type, full, meta) {
          if (full.current_events.length) {
            return '<a href="'+full.current_events[0].event_url+'">'+data+'</a>'
          }
        }
      }
    ]
  });
});

  // Resize iframe to fit content
  function resize() {
    var newheight = document.getElementById("widget").contentWindow.document.body.scrollHeight;
    document.getElementById("widget").height = newheight + "px";
  }
</script>

</html>
