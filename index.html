<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="//cloud.webtype.com/css/944a7551-9b08-4f0a-8767-e0f83db4a16b.css" />
    <link rel="stylesheet" href="http://style.codeforamerica.org/style/css/main.css">
    <link rel="stylesheet" href="http://style.codeforamerica.org/style/css/layout.css" media="all and (min-width: 40em)">
    <link rel="stylesheet" href="css/style.css">
    <title>Code for All</title>

    <script src='//code.jquery.com/jquery-2.1.0.min.js'></script>
    <link href='//api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
    <script src='//api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
</head>

<body>

  <div class="global-header-compact" role="banner">
    <a href="http://codeforall.org" class="global-header-logo">
        <img src="images/code_for_all_logo.png" />
    </a>
    <p class="global-header-tagline">An international network of <strong>civic innovators</strong>. </p>
  </div>

    <section>
      <div id="map"></map>
    </section>

    <section class="slab-white">
        <div class="layout-breve">
            <div class="layout-minor">
                <h3 id="numOfProjects"></h3>
                <p class="text-whisper">Code for All projects!</p>
            </div>
            <div class="layout-major">
                <div class="badge-heading badge-github badge-blue" id="recentProject">
                </div>
            </div>
        </div>
    </section>

    <section class="slab-blue">
        <div class="layout-breve">
            <div class="layout-minor">
                <h3 id="numOfGroups"></h3>
                <p class="text-whisper">Code for All groups.</p>
            </div>
            <div class="layout-major">
                <div class="badge-heading badge-glasses badge-dark-blue" id="recentStory">
                </div>
            </div>
        </div>
    </section>

    <section class="slab-dark-blue">
        <div class="layout-breve">
            <div class="layout-minor">
                <h3>Recent Event</h3>
            </div>
            <div class="layout-major" id="recentEvent">
            </div>
        </div>
    </section>

    <section>
          <div class="layout-breve">
            <div class="badge-heading badge-github badge-blue">
                <h2>Code for All Right Now!</h2>
                <p>These are open GitHub Issues labeled with
                <span class="label" style="background-color:#159818;">help wanted</span>
                from across the civic technology movement. Find more using the
                <a href="http://codeforamerica.org/geeks/civicissues">Civic Tech Issue Finder</a>.</p>
            </div>
            <style>
              .label {
                border: 1px solid #000;
                display: inline-block;
                color: #fff;
                text-align: center;
                border-radius: .33em;
                margin: 5px;
                padding: 0 10px;
                font-family: Interstate, 'Gotham A', 'Gotham B', 'Open Sans Regular', Verdana, Helvetica, Arial;
              }
            </style>
            <iframe id="widget" src="http://codeforamerica.org/geeks/civicissues/widget?labels=help wanted&number=3" width="100%" height="320px" frameBorder="0" onLoad="resize();"> </iframe>
          </div>
        </section>

</body>

<script>
  function showMap(cfallOrgs){
    // Show Map

    // codeforamerica.j113mi4d - code for all
    // codeforamerica.map-hhckoiuj - brigade
    var map = L.mapbox.map('map', 'codeforamerica.map-hhckoiuj',
    {
      scrollWheelZoom:false
    });
    var latlon = [27, 0], zoom = 2;
    map.setView(latlon, zoom);

    // Add the cfall orgs to the map
    var featureLayer = L.mapbox.featureLayer(cfallOrgs).addTo(map);

    featureLayer.on('mouseover', function(e) {
        e.layer.openPopup();
    });

  };

  function getData(){
    // Get all CfAll organizations
    $.getJSON("http://codeforamerica.org/api/organizations.geojson", function (response){

      var orgs = response;
      var cfallOrgs = [];
      orgs.features.forEach(function(org) {
        if (org.properties.type.indexOf("Code for All") != -1){
          org.properties['marker-symbol'] = 'rocket';
          org.properties['title'] = "<a href="+org.properties.website+">"+org.properties.name + "</a>";
          cfallOrgs.push(org);
        }
      });

      showMap(cfallOrgs);
      showRecentProject();
      showRecentStory();
      showRecentEvent();
      getNums(cfallOrgs);
    })
  }

  function showRecentProject(){
      $.getJSON("http://codeforamerica.org/api/projects?organization_type=Code for All&per_page=1", function (response){

        var project = response.objects[0];
        var html = '<h3><a href="' + project.code_url + '">' + project.name + '</a></h3>' +
                    '<p>' + project.description + '</p>' +
                    '<p>By: <a href="' + project.organization.website + '"</a>' +
                    project.organization.name + '</p>';
        $("#recentProject").append( html );
      });
  }

  function showRecentStory(){
      $.getJSON("http://codeforamerica.org/api/stories?organization_type=Code for All&per_page=1", function (response){

        var story = response.objects[0];
        var html = '<h3><a href="' + story.link + '">' + story.title + '</a></h3>' +
                    '<p>By: <a href="' + story.organization.website + '"</a>' +
                    story.organization.name + '</p>';
        $("#recentStory").append( html );
      });
  }

  function showRecentEvent(){
      $.getJSON("http://codeforamerica.org/api/events/past_events?organization_type=Code for All&per_page=1", function (response){

        var event = response.objects[0];
        var html = '<h3><a href="' + event.event_url + '">' + event.name + '</a></h3>' +
                    '<p>By: <a href="' + event.organization.website + '"</a>' +
                    event.organization.name + '</p>';
        $("#recentEvent").append( html );
      });
  }

  function getNums(cfallOrgs){
    // Add num of groups
    $("#numOfGroups").html(cfallOrgs.length);

    // Add num of projects
    $.getJSON("http://codeforamerica.org/api/projects?organization_type=Code for All", function (response) {
        $("#numOfProjects").html(response.total);
    });

    // // Add num of events
    // $.getJSON("http://codeforamerica.org/api/events?organization_type=Code for All", function (response) {
    //     $("#numOfEvents").html(response.total);
    // });
  }

  getData();
</script>

</html>
